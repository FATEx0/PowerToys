name: Release Build

on:
  push:
    tags:
      - 'v*'  # Trigger on semantic version tags (e.g. v1.0.0)

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      SOLUTION_DIR: ${{ github.workspace }}
      WIX_PATH: 'C:\Program Files (x86)\WiX Toolset v3.14\bin'

    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Add WiX Toolset to PATH
      run: |
        echo "$env:WIX_PATH" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install WiX Toolset
      run: |
        choco install wixtoolset -y --version 3.14.0
        & "${env:WIX_PATH}\heat.exe" --help

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Restore NuGet packages
      run: nuget restore PowerToys.sln

    - name: Build Solution (Release x64)
      run: msbuild PowerToys.sln /p:Configuration=Release /p:Platform=x64 /p:RestorePackages=false

    - name: Build Prerequisite Tools
      run: |
        msbuild tools\BugReportTool\BugReportTool.sln /p:Configuration=Release /p:Platform=x64
        msbuild tools\StylesReportTool\StylesReportTool.sln /p:Configuration=Release /p:Platform=x64

    - name: Build Installer
      run: msbuild installer\PowerToysSetup.sln /p:Configuration=Release /p:Platform=x64

    - name: Collect Artifacts
      run: |
        mkdir artifacts
        copy "installer\PowerToysSetup\x64\Release\PowerToysSetup.msi" artifacts\
        copy "installer\PowerToysSetup\x64\Release\PowerToysSetup.exe" artifacts\

    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-binaries
        path: artifacts/*

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/PowerToysSetup.msi
        asset_name: PowerToysSetup-${{ github.ref }}.msi
        asset_content_type: application/octet-stream